<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/layout :: head"></head>

<body>
<!-- HEADER -->
<header th:replace="fragments/layout :: header"></header>
<!-- /HEADER -->

<!-- NAVIGATION -->
<nav th:replace="fragments/layout :: navigation"></nav>
<!-- /NAVIGATION -->

<!-- SECTION -->
<div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h2>Administração de Jogos</h2>

                <!-- Mensagens de feedback -->
                <div th:if="${sucesso}" class="alert alert-success alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <span th:text="${sucesso}"></span>
                </div>

                <div th:if="${erro}" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <span th:text="${erro}"></span>
                </div>

                <!-- Botão para cadastrar novo jogo -->
                <div class="mb-3" style="margin-bottom: 20px;">
                    <a th:href="@{/cadastro}" class="btn btn-primary">
                        <i class="fa fa-plus"></i> Cadastrar Novo Jogo
                    </a>
                </div>

                <!-- Tabela de jogos -->
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Imagem</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Preço</th>
                            <th>Idade Mín.</th>
                            <th>Jogadores</th>
                            <th>Tempo (min)</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="jogo : ${jogos}" th:class="${jogo.deleted} ? 'danger' : ''">
                            <td th:text="${jogo.id}">1</td>
                            <td>
                                <!-- Imagem com múltiplos fallbacks -->
                                <div style="position: relative; width: 50px; height: 50px;">
                                    <img th:src="${jogo.imgUrl}"
                                         th:alt="'Imagem do jogo ' + ${jogo.nome}"
                                         style="width: 100%; height: 100%; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; display: block;"
                                         th:onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
                                         th:onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'; console.log('Erro ao carregar imagem: ' + this.src);">

                                    <!-- Fallback quando imagem falha -->
                                    <div style="width: 100%; height: 100%; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; display: none; align-items: center; justify-content: center; font-size: 10px; color: #666; text-align: center;">
                                        <i class="fa fa-image" style="font-size: 16px; color: #ccc;"></i>
                                    </div>
                                </div>

                                <!-- Debug: Mostrar URL da imagem (remover em produção) -->
                                <small th:text="${jogo.imgUrl}" style="font-size: 9px; color: #666; word-break: break-all; display: block; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" th:title="${jogo.imgUrl}"></small>
                            </td>
                            <td th:text="${jogo.nome}">Nome do Jogo</td>
                            <td th:text="${jogo.categoria}">Categoria</td>
                            <td th:text="'R$ ' + ${#numbers.formatDecimal(jogo.preco, 1, 2)}">R$ 0,00</td>
                            <td th:text="${jogo.idadeMinima} + '+'">0+</td>
                            <td th:text="${jogo.numeroJogadores}">0</td>
                            <td th:text="${jogo.tempoJogoMinutos}">0</td>
                            <td>
                                <span th:if="${jogo.deleted}" class="label label-danger">Deletado</span>
                                <span th:unless="${jogo.deleted}" class="label label-success">Ativo</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a th:href="@{/editar(id=${jogo.id})}"
                                       class="btn btn-sm btn-warning" title="Editar">
                                        <i class="fa fa-edit"></i>
                                    </a>

                                    <a th:if="${!jogo.deleted}"
                                       th:href="@{/deletar(id=${jogo.id})}"
                                       class="btn btn-sm btn-danger"
                                       title="Deletar"
                                       onclick="return confirm('Tem certeza que deseja deletar este jogo?')">
                                        <i class="fa fa-trash"></i>
                                    </a>

                                    <a th:if="${jogo.deleted}"
                                       th:href="@{/restaurar(id=${jogo.id})}"
                                       class="btn btn-sm btn-success"
                                       title="Restaurar"
                                       onclick="return confirm('Tem certeza que deseja restaurar este jogo?')">
                                        <i class="fa fa-undo"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Estatísticas -->
                <div class="row" style="margin-top: 30px;">
                    <div class="col-md-4">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title">Total de Jogos</h3>
                            </div>
                            <div class="panel-body">
                                <h2 th:text="${jogos.size()}">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <h3 class="panel-title">Jogos Ativos</h3>
                            </div>
                            <div class="panel-body">
                                <h2 th:text="${#lists.size(jogos.?[!deleted])}">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-danger">
                            <div class="panel-heading">
                                <h3 class="panel-title">Jogos Deletados</h3>
                            </div>
                            <div class="panel-body">
                                <h2 th:text="${#lists.size(jogos.?[deleted])}">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /SECTION -->

<!-- FOOTER -->
<footer th:replace="fragments/layout :: footer"></footer>
<!-- /FOOTER -->

<!-- Scripts -->
<div th:replace="fragments/layout :: scripts"></div>

<!-- Script para debug de imagens -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Log das URLs das imagens para debug
        const images = document.querySelectorAll('table img');
        console.log('=== DEBUG DE IMAGENS NO ADMIN ===');
        console.log('Total de imagens encontradas:', images.length);

        images.forEach((img, index) => {
            console.log(`Imagem ${index + 1}:`);
            console.log(`  - URL: ${img.src}`);
            console.log(`  - Alt: ${img.alt}`);

            // Verificar se a imagem carregou
            if (img.complete) {
                if (img.naturalWidth > 0) {
                    console.log(`  - Status: ✓ Carregada (${img.naturalWidth}x${img.naturalHeight})`);
                } else {
                    console.log(`  - Status: ✗ Erro ao carregar`);
                }
            } else {
                console.log(`  - Status: ⏳ Carregando...`);

                img.onload = function() {
                    console.log(`  - Status: ✓ Carregada após aguardar (${this.naturalWidth}x${this.naturalHeight})`);
                };

                img.onerror = function() {
                    console.log(`  - Status: ✗ Erro ao carregar após aguardar`);
                };
            }
        });

        // Testar URLs de exemplo
        console.log('\n=== TESTE DE URLS RECOMENDADAS ===');
        const urlsTeste = [
            'https://picsum.photos/300/200?random=1',
            'https://via.placeholder.com/300x200?text=Teste',
            'https://source.unsplash.com/300x200/?game'
        ];

        urlsTeste.forEach((url, index) => {
            const img = new Image();
            img.onload = function() {
                console.log(`✓ URL ${index + 1} funciona: ${url}`);
            };
            img.onerror = function() {
                console.log(`✗ URL ${index + 1} falhou: ${url}`);
            };
            img.src = url;
        });
    });
</script>
</body>
</html>

