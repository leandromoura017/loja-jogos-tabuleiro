<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/layout :: head"></head>

<body>
<!-- HEADER -->
<header th:replace="fragments/layout :: header"></header>
<!-- /HEADER -->

<!-- NAVIGATION -->
<nav th:replace="fragments/layout :: navigation"></nav>
<!-- /NAVIGATION -->

<!-- SECTION -->
<div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <h2 th:text="${jogo.id != null ? 'Editar Jogo' : 'Cadastrar Novo Jogo'}">Cadastrar Novo Jogo</h2>

                <!-- Mensagens de feedback -->
                <div th:if="${sucesso}" class="alert alert-success alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <span th:text="${sucesso}"></span>
                </div>

                <div th:if="${erro}" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <span th:text="${erro}"></span>
                </div>

                <!-- Formulário -->
                <form th:action="@{/salvar}" th:object="${jogo}" method="post" enctype="multipart/form-data" class="form-horizontal">

                    <!-- Token CSRF (se necessário) -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Campo oculto para ID (usado na edição) -->
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{deleted}">
                    <input type="hidden" th:field="*{dataCadastro}">

                    <!-- Imagem Atual (se editando) -->
                    <div class="form-group" th:if="${jogo.id != null and jogo.imgUrl != null}">
                        <label class="col-sm-3 control-label">Imagem Atual</label>
                        <div class="col-sm-9">
                            <img th:src="${jogo.imgUrl}"
                                 th:alt="'Imagem atual do jogo ' + ${jogo.nome}"
                                 style="max-width: 200px; max-height: 150px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;"
                                 onerror="this.src='https://picsum.photos/200/150?text=Erro+ao+Carregar'; this.style.backgroundColor='#f8f9fa';">
                            <br><small th:text="'URL: ' + ${jogo.imgUrl}" style="font-size: 10px; color: #666; word-break: break-all;"></small>
                        </div>
                    </div>

                    <!-- URL da Imagem Externa -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('imgUrl')} ? 'has-error'">
                        <label for="imgUrl" class="col-sm-3 control-label">URL da Imagem</label>
                        <div class="col-sm-9">
                            <input type="url" class="form-control" id="imgUrl" th:field="*{imgUrl}"
                                   placeholder="https://exemplo.com/imagem.jpg" onchange="previewUrl(this)">
                            <span class="help-block" th:if="${#fields.hasErrors('imgUrl')}"
                                  th:errors="*{imgUrl}">Erro na URL da imagem</span>
                            <small class="help-block">
                                Cole a URL de uma imagem externa. Recomendado:
                                <a href="https://picsum.photos/300/200" target="_blank">Picsum Photos</a>,
                                <a href="https://via.placeholder.com/300x200" target="_blank">Placeholder.com</a>
                            </small>

                            <!-- Preview da URL -->
                            <div id="preview-url-container" style="margin-top: 10px; display: none;">
                                <img id="preview-url" style="max-width: 200px; max-height: 150px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;"
                                     onerror="this.style.display='none'; document.getElementById('url-error').style.display='block';">
                                <div id="url-error" style="display: none; color: #d9534f; font-size: 12px;">❌ Erro ao carregar imagem da URL</div>
                                <br><small style="color: #666;">Preview da URL externa</small>
                            </div>
                        </div>
                    </div>

                    <!-- Nome -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('nome')} ? 'has-error'">
                        <label for="nome" class="col-sm-3 control-label">Nome *</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="nome" th:field="*{nome}"
                                   placeholder="Digite o nome do jogo" required>
                            <span class="help-block" th:if="${#fields.hasErrors('nome')}"
                                  th:errors="*{nome}">Erro no nome</span>
                        </div>
                    </div>

                    <!-- Descrição -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('descricao')} ? 'has-error'">
                        <label for="descricao" class="col-sm-3 control-label">Descrição *</label>
                        <div class="col-sm-9">
                                <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                          rows="4" placeholder="Digite a descrição do jogo" required></textarea>
                            <span class="help-block" th:if="${#fields.hasErrors('descricao')}"
                                  th:errors="*{descricao}">Erro na descrição</span>
                        </div>
                    </div>

                    <!-- Preço -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('preco')} ? 'has-error'">
                        <label for="preco" class="col-sm-3 control-label">Preço (R$) *</label>
                        <div class="col-sm-9">
                            <input type="number" step="0.01" min="0.01" class="form-control" id="preco" th:field="*{preco}"
                                   placeholder="0.00" required>
                            <span class="help-block" th:if="${#fields.hasErrors('preco')}"
                                  th:errors="*{preco}">Erro no preço</span>
                        </div>
                    </div>

                    <!-- Idade Mínima -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('idadeMinima')} ? 'has-error'">
                        <label for="idadeMinima" class="col-sm-3 control-label">Idade Mínima *</label>
                        <div class="col-sm-9">
                            <input type="number" min="1" max="99" class="form-control" id="idadeMinima" th:field="*{idadeMinima}"
                                   placeholder="Ex: 8" required>
                            <span class="help-block" th:if="${#fields.hasErrors('idadeMinima')}"
                                  th:errors="*{idadeMinima}">Erro na idade mínima</span>
                        </div>
                    </div>

                    <!-- Número de Jogadores -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('numeroJogadores')} ? 'has-error'">
                        <label for="numeroJogadores" class="col-sm-3 control-label">Número de Jogadores *</label>
                        <div class="col-sm-9">
                            <input type="number" min="1" max="20" class="form-control" id="numeroJogadores" th:field="*{numeroJogadores}"
                                   placeholder="Ex: 4" required>
                            <span class="help-block" th:if="${#fields.hasErrors('numeroJogadores')}"
                                  th:errors="*{numeroJogadores}">Erro no número de jogadores</span>
                        </div>
                    </div>

                    <!-- Tempo de Jogo -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('tempoJogoMinutos')} ? 'has-error'">
                        <label for="tempoJogoMinutos" class="col-sm-3 control-label">Tempo de Jogo (min) *</label>
                        <div class="col-sm-9">
                            <input type="number" min="1" max="999" class="form-control" id="tempoJogoMinutos" th:field="*{tempoJogoMinutos}"
                                   placeholder="Ex: 60" required>
                            <span class="help-block" th:if="${#fields.hasErrors('tempoJogoMinutos')}"
                                  th:errors="*{tempoJogoMinutos}">Erro no tempo de jogo</span>
                        </div>
                    </div>

                    <!-- Categoria -->
                    <div class="form-group" th:classappend="${#fields.hasErrors('categoria')} ? 'has-error'">
                        <label for="categoria" class="col-sm-3 control-label">Categoria *</label>
                        <div class="col-sm-9">
                            <select class="form-control" id="categoria" th:field="*{categoria}" required>
                                <option value="">Selecione uma categoria</option>
                                <option value="Estratégia">Estratégia</option>
                                <option value="Família">Família</option>
                                <option value="Cooperativo">Cooperativo</option>
                                <option value="Party Games">Party Games</option>
                                <option value="Clássico">Clássico</option>
                                <option value="Aventura">Aventura</option>
                                <option value="Educativo">Educativo</option>
                            </select>
                            <span class="help-block" th:if="${#fields.hasErrors('categoria')}"
                                  th:errors="*{categoria}">Erro na categoria</span>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save"></i>
                                <span th:text="${jogo != null and jogo.id != null ? 'Atualizar' : 'Cadastrar'}">Cadastrar</span>
                            </button>
                            <a th:href="@{/admin}" class="btn btn-default">
                                <i class="fa fa-times"></i> Cancelar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /SECTION -->

<!-- FOOTER -->
<footer th:replace="fragments/layout :: footer"></footer>
<!-- /FOOTER -->

<!-- Scripts -->
<div th:replace="fragments/layout :: scripts"></div>

<!-- Script para preview de imagens -->
<script>
    // Preview da imagem selecionada via upload
    function previewImagem(input) {
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-imagem');

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';

                // Limpar URL externa se arquivo foi selecionado
                document.getElementById('imgUrl').value = '';
                document.getElementById('preview-url-container').style.display = 'none';
            };

            reader.readAsDataURL(input.files[0]);
        } else {
            previewContainer.style.display = 'none';
        }
    }

    // Preview da URL externa
    function previewUrl(input) {
        const previewContainer = document.getElementById('preview-url-container');
        const previewImg = document.getElementById('preview-url');
        const errorDiv = document.getElementById('url-error');

        if (input.value.trim()) {
            previewImg.src = input.value.trim();
            previewImg.style.display = 'block';
            errorDiv.style.display = 'none';
            previewContainer.style.display = 'block';

            // Limpar arquivo se URL foi inserida
            document.getElementById('imagemArquivo').value = '';
            document.getElementById('preview-container').style.display = 'none';
        } else {
            previewContainer.style.display = 'none';
        }
    }

    // Validação do formulário
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');

        form.addEventListener('submit', function(e) {
            const nome = document.getElementById('nome').value.trim();
            const preco = parseFloat(document.getElementById('preco').value);
            const categoria = document.getElementById('categoria').value;

            if (!nome) {
                alert('Nome do jogo é obrigatório!');
                e.preventDefault();
                return;
            }

            if (!preco || preco <= 0) {
                alert('Preço deve ser maior que zero!');
                e.preventDefault();
                return;
            }

            if (!categoria) {
                alert('Categoria é obrigatória!');
                e.preventDefault();
                return;
            }

            console.log('Formulário sendo enviado com dados:', {
                nome: nome,
                preco: preco,
                categoria: categoria
            });
        });
    });
</script>
</body>
</html>

